# Stripeæ±ºæ¸ˆæ©Ÿèƒ½ è¦ä»¶å®šç¾©æ›¸

## 1. æ¦‚è¦

### 1.1 ç›®çš„
TOEIC Part7ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°Webã‚µãƒ¼ãƒ“ã‚¹ã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å‹èª²é‡‘æ©Ÿèƒ½ã‚’å°å…¥ã—ã€ãƒ•ãƒªãƒ¼ãƒŸã‚¢ãƒ ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹åç›ŠåŒ–ã‚’å®Ÿç¾ã™ã‚‹ã€‚

### 1.2 å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼
- **ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆFreeï¼‰**: åŸºæœ¬æ©Ÿèƒ½ã®ã¿åˆ©ç”¨å¯èƒ½ï¼ˆæ—¥æ¬¡åˆ¶é™ã‚ã‚Šï¼‰
- **æœ‰æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆProï¼‰**: å…¨æ©Ÿèƒ½è§£æ”¾

### 1.3 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
| é …ç›® | æŠ€è¡“ |
|------|------|
| æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ | Stripe |
| é€šè²¨ | æ—¥æœ¬å††ï¼ˆJPYï¼‰ã®ã¿ |
| ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç† | Stripe Billing |
| æ±ºæ¸ˆUI | Stripe Checkoutï¼ˆãƒ›ã‚¹ãƒˆå‹ï¼‰ |
| é¡§å®¢ãƒãƒ¼ã‚¿ãƒ« | Stripe Customer Portal |
| Webhook | Stripe Webhooks |

---

## 2. æ–™é‡‘ãƒ—ãƒ©ãƒ³å®šç¾©

### 2.1 ãƒ—ãƒ©ãƒ³ä¸€è¦§

| ãƒ—ãƒ©ãƒ³ | æœˆé¡æ–™é‡‘ | èª¬æ˜ |
|--------|----------|------|
| **Free** | 0å†† | åŸºæœ¬æ©Ÿèƒ½ã®ã¿ï¼ˆæ—¥æ¬¡åˆ¶é™ã‚ã‚Šï¼‰ |
| **Pro** | 480å†† | å…¨æ©Ÿèƒ½è§£æ”¾ |

### 2.2 å„ãƒ—ãƒ©ãƒ³ã§åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½

| æ©Ÿèƒ½ | Free | Pro |
|------|:----:|:---:|
| **åŸºæœ¬å­¦ç¿’æ©Ÿèƒ½** | | |
| é•·æ–‡èª­è§£ï¼ˆPart7ï¼‰ | 5å•/æ—¥ | ç„¡åˆ¶é™ |
| æ–‡æ³•å­¦ç¿’ï¼ˆPart5/6ï¼‰ | 10å•/æ—¥ | ç„¡åˆ¶é™ |
| å˜èªå­¦ç¿’ | 20èª/æ—¥ | ç„¡åˆ¶é™ |
| åŸºæœ¬ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | â—‹ | â—‹ |
| **æ¨¡è©¦æ©Ÿèƒ½** | | |
| ãƒŸãƒ‹æ¨¡è©¦ï¼ˆ15åˆ†/30åˆ†ï¼‰ | âœ— | â—‹ |
| ãƒ•ãƒ«æ¨¡è©¦ï¼ˆ75åˆ†/100å•ï¼‰ | âœ— | â—‹ |
| **åˆ†ææ©Ÿèƒ½** | | |
| å¼±ç‚¹åˆ†æ | âœ— | â—‹ |
| ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆ | âœ— | â—‹ |
| æ—¥åˆ¥æ¨ç§»ã‚°ãƒ©ãƒ• | âœ— | â—‹ |
| **å¾©ç¿’æ©Ÿèƒ½** | | |
| ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ | âœ— | ç„¡åˆ¶é™ |
| å¾©ç¿’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« | âœ— | â—‹ |
| é–“éš”åå¾©å­¦ç¿’ | âœ— | â—‹ |
| **AIæ©Ÿèƒ½** | | |
| AIé•·æ–‡ç”Ÿæˆ | âœ— | ç„¡åˆ¶é™ |
| AIæ–‡æ³•å•é¡Œç”Ÿæˆ | âœ— | ç„¡åˆ¶é™ |
| AIå˜èªç”Ÿæˆ | âœ— | ç„¡åˆ¶é™ |

---

## 3. æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼

### 3.1 ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³åŠ å…¥ãƒ•ãƒ­ãƒ¼

```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼] --> [æ–™é‡‘ãƒ—ãƒ©ãƒ³ãƒšãƒ¼ã‚¸ (/pricing)]
                    |
                    v
            [ãƒ—ãƒ©ãƒ³ãƒ»æœŸé–“é¸æŠ]
                    |
                    v
            [Stripe Checkout Sessionä½œæˆ]
            (Server Action: createCheckoutSession)
                    |
                    v
            [Stripe Checkoutç”»é¢]
            (StripeãŒãƒ›ã‚¹ãƒˆã€æ—¥æœ¬èªå¯¾å¿œ)
                    |
         +----------+-----------+
         |                      |
         v                      v
   [æ±ºæ¸ˆæˆåŠŸ]              [ã‚­ãƒ£ãƒ³ã‚»ãƒ«]
         |                      |
         v                      v
   [/payment/success]     [/payment/cancel]
         |
         v
   [Webhook: checkout.session.completed]
         |
         v
   [DBã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆãƒ»æ›´æ–°]
```

### 3.2 è§£ç´„ãƒ•ãƒ­ãƒ¼

```
[è§£ç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ] --> [cancel_at_period_end = true]
                           |
                           v
                    [ç¾åœ¨ã®æœŸé–“çµ‚äº†ã¾ã§ç¶™ç¶šåˆ©ç”¨å¯èƒ½]
                           |
                           v
                    [æœŸé–“çµ‚äº†æ™‚: Freeãƒ—ãƒ©ãƒ³ã«ç§»è¡Œ]
```

- å³æ™‚è§£ç´„ã§ã¯ãªãã€æœŸé–“çµ‚äº†æ™‚ã«è§£ç´„ï¼ˆcancel_at_period_endï¼‰
- è§£ç´„äºˆå®šçŠ¶æ…‹ã®è¡¨ç¤º
- è§£ç´„å–ã‚Šæ¶ˆã—æ©Ÿèƒ½ã‚ã‚Š

### 3.3 æ”¯æ‰•ã„å¤±æ•—å¯¾å¿œ

| ãƒ•ã‚§ãƒ¼ã‚º | å¯¾å¿œ |
|---------|------|
| åˆå›å¤±æ•— | StripeãŒè‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼ˆ3å›ã¾ã§ï¼‰ |
| ãƒªãƒˆãƒ©ã‚¤æœŸé–“ | æ”¯æ‰•ã„å¤±æ•—é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ |
| çŒ¶äºˆæœŸé–“ | 7æ—¥é–“ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ç¶™ç¶šåˆ©ç”¨å¯èƒ½ï¼‰ |
| çŒ¶äºˆæœŸé–“çµ‚äº† | Freeãƒ—ãƒ©ãƒ³ã«ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰ |

---

## 4. Webhookå‡¦ç†

### 4.1 å¯¾å¿œã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§

| ã‚¤ãƒ™ãƒ³ãƒˆ | å‡¦ç†å†…å®¹ |
|----------|----------|
| `checkout.session.completed` | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆã€DBã«åæ˜  |
| `customer.subscription.created` | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ä¿å­˜ |
| `customer.subscription.updated` | ãƒ—ãƒ©ãƒ³å¤‰æ›´ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚’åæ˜  |
| `customer.subscription.deleted` | ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çµ‚äº†å‡¦ç†ï¼ˆFreeã«ç§»è¡Œï¼‰ |
| `invoice.paid` | æ”¯æ‰•ã„æˆåŠŸã‚’è¨˜éŒ²ã€è«‹æ±‚å±¥æ­´ä¿å­˜ |
| `invoice.payment_failed` | æ”¯æ‰•ã„å¤±æ•—ã‚’è¨˜éŒ²ã€é€šçŸ¥å‡¦ç† |
| `customer.updated` | é¡§å®¢æƒ…å ±æ›´æ–°ï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰ |

### 4.2 Webhook ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

```typescript
// ç½²åæ¤œè¨¼å¿…é ˆ
const event = stripe.webhooks.constructEvent(
  body,
  signature,
  process.env.STRIPE_WEBHOOK_SECRET!
)
```

---

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 5.1 æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«

#### 5.1.1 subscriptionsï¼ˆã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

```sql
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  stripe_customer_id VARCHAR(255) UNIQUE,
  stripe_subscription_id VARCHAR(255) UNIQUE,
  plan_type VARCHAR(20) NOT NULL DEFAULT 'free'
    CHECK (plan_type IN ('free', 'pro')),
  status VARCHAR(30) NOT NULL DEFAULT 'active'
    CHECK (status IN ('active', 'canceled', 'past_due', 'incomplete', 'trialing')),
  current_period_start TIMESTAMPTZ,
  current_period_end TIMESTAMPTZ,
  cancel_at_period_end BOOLEAN DEFAULT false,
  canceled_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_subscriptions_user ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_stripe_customer ON subscriptions(stripe_customer_id);
CREATE INDEX idx_subscriptions_stripe_subscription ON subscriptions(stripe_subscription_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
```

#### 5.1.2 invoicesï¼ˆè«‹æ±‚å±¥æ­´ï¼‰

```sql
CREATE TABLE invoices (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  subscription_id UUID NOT NULL REFERENCES subscriptions(id) ON DELETE CASCADE,
  stripe_invoice_id VARCHAR(255) UNIQUE NOT NULL,
  stripe_payment_intent_id VARCHAR(255),
  amount_paid INTEGER NOT NULL, -- æ—¥æœ¬å††ï¼ˆæ•´æ•°ï¼‰
  currency VARCHAR(3) DEFAULT 'jpy',
  status VARCHAR(30) NOT NULL,
  invoice_pdf_url TEXT,
  hosted_invoice_url TEXT,
  paid_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_invoices_user ON invoices(user_id);
CREATE INDEX idx_invoices_subscription ON invoices(subscription_id);
CREATE INDEX idx_invoices_stripe_invoice ON invoices(stripe_invoice_id);
```

#### 5.1.3 subscription_logsï¼ˆå¤‰æ›´å±¥æ­´ï¼‰

```sql
CREATE TABLE subscription_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE SET NULL,
  event_type VARCHAR(50) NOT NULL,
    -- 'created', 'upgraded', 'downgraded', 'canceled', 'renewed', 'payment_failed'
  previous_plan VARCHAR(20),
  new_plan VARCHAR(20),
  stripe_event_id VARCHAR(255),
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_subscription_logs_user ON subscription_logs(user_id);
CREATE INDEX idx_subscription_logs_event ON subscription_logs(event_type);
CREATE INDEX idx_subscription_logs_created ON subscription_logs(created_at);
```

#### 5.1.4 usage_limitsï¼ˆåˆ©ç”¨åˆ¶é™è¿½è·¡ï¼‰

```sql
CREATE TABLE usage_limits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  usage_date DATE NOT NULL,
  -- æ—¥æ¬¡ã‚«ã‚¦ãƒ³ãƒˆ
  reading_count INTEGER DEFAULT 0,
  grammar_count INTEGER DEFAULT 0,
  vocabulary_count INTEGER DEFAULT 0,
  -- æœˆæ¬¡ã‚«ã‚¦ãƒ³ãƒˆï¼ˆAIç”Ÿæˆï¼‰
  ai_passage_count INTEGER DEFAULT 0,
  ai_grammar_count INTEGER DEFAULT 0,
  ai_vocabulary_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, usage_date)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_usage_limits_user_date ON usage_limits(user_id, usage_date);
```

### 5.2 profilesãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ

```sql
-- profilesãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã‚‹ã‚«ãƒ©ãƒ 
ALTER TABLE profiles ADD COLUMN stripe_customer_id VARCHAR(255) UNIQUE;
```

### 5.3 RLSãƒãƒªã‚·ãƒ¼

```sql
-- subscriptions
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own subscription" ON subscriptions
  FOR SELECT USING (auth.uid() = user_id);

-- Webhookå‡¦ç†ã¯Service Role Keyã§è¡Œã†ãŸã‚ã€åˆ¥é€”ãƒãƒªã‚·ãƒ¼ä¸è¦

-- invoices
ALTER TABLE invoices ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own invoices" ON invoices
  FOR SELECT USING (auth.uid() = user_id);

-- subscription_logs
ALTER TABLE subscription_logs ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own subscription logs" ON subscription_logs
  FOR SELECT USING (auth.uid() = user_id);

-- usage_limits
ALTER TABLE usage_limits ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own usage limits" ON usage_limits
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can update own usage limits" ON usage_limits
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own usage limits" ON usage_limits
  FOR INSERT WITH CHECK (auth.uid() = user_id);
```

---

## 6. ç”»é¢è¨­è¨ˆ

### 6.1 æ–°è¦ç”»é¢ä¸€è¦§

| ç”»é¢ | ãƒ‘ã‚¹ | èª¬æ˜ |
|------|------|------|
| æ–™é‡‘ãƒ—ãƒ©ãƒ³ãƒšãƒ¼ã‚¸ | `/pricing` | ãƒ—ãƒ©ãƒ³æ¯”è¼ƒãƒ»é¸æŠç”»é¢ |
| æ±ºæ¸ˆæˆåŠŸãƒšãƒ¼ã‚¸ | `/payment/success` | Checkoutå®Œäº†å¾Œã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆ |
| æ±ºæ¸ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒšãƒ¼ã‚¸ | `/payment/cancel` | Checkoutã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆ |
| è¨­å®šãƒˆãƒƒãƒ— | `/settings` | è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ |
| ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç† | `/settings/subscription` | ãƒ—ãƒ©ãƒ³ç¢ºèªãƒ»å¤‰æ›´ãƒ»è§£ç´„ |
| è«‹æ±‚å±¥æ­´ | `/settings/billing` | è«‹æ±‚å±¥æ­´ä¸€è¦§ãƒ»é ˜åæ›¸ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ |

### 6.2 æ–™é‡‘ãƒ—ãƒ©ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆ/pricingï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Logo] TOEIC Part7 Training                    [ãƒ­ã‚°ã‚¤ãƒ³]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚             ã‚·ãƒ³ãƒ—ãƒ«ãªæ–™é‡‘ãƒ—ãƒ©ãƒ³                                  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚        Free         â”‚  â”‚     Pro ãƒ—ãƒ©ãƒ³       â”‚              â”‚
â”‚  â”‚                     â”‚  â”‚     â˜…ãŠã™ã™ã‚       â”‚              â”‚
â”‚  â”‚        Â¥0          â”‚  â”‚     Â¥480/æœˆ        â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚ âœ“ é•·æ–‡5å•/æ—¥        â”‚  â”‚ âœ“ å…¨æ©Ÿèƒ½è§£æ”¾        â”‚              â”‚
â”‚  â”‚ âœ“ æ–‡æ³•10å•/æ—¥       â”‚  â”‚ âœ“ ç„¡åˆ¶é™å­¦ç¿’        â”‚              â”‚
â”‚  â”‚ âœ“ å˜èª20èª/æ—¥       â”‚  â”‚ âœ“ æ¨¡è©¦æ©Ÿèƒ½          â”‚              â”‚
â”‚  â”‚ âœ“ åŸºæœ¬ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ â”‚  â”‚ âœ“ è©³ç´°åˆ†æ          â”‚              â”‚
â”‚  â”‚                     â”‚  â”‚ âœ“ å¾©ç¿’æ©Ÿèƒ½          â”‚              â”‚
â”‚  â”‚                     â”‚  â”‚ âœ“ AIå•é¡Œç”Ÿæˆ        â”‚              â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚  â”‚   [ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³]     â”‚  â”‚   [Proã«åŠ å…¥]       â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                 â”‚
â”‚  ã‚ˆãã‚ã‚‹è³ªå•                                                    â”‚
â”‚  â”œ ã„ã¤ã§ã‚‚è§£ç´„ã§ãã¾ã™ã‹ï¼Ÿ â†’ ã¯ã„ã€æ¬¡å›è«‹æ±‚æ—¥ã¾ã§ç¶™ç¶š            â”‚
â”‚  â”” æ”¯æ‰•ã„æ–¹æ³•ã¯ï¼Ÿ â†’ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ãƒ»ãƒ‡ãƒ“ãƒƒãƒˆã‚«ãƒ¼ãƒ‰              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.3 ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ç”»é¢ï¼ˆ/settings/subscriptionï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [â†] ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Pro ãƒ—ãƒ©ãƒ³                                          â”‚       â”‚
â”‚  â”‚  Â¥480/æœˆ                                            â”‚       â”‚
â”‚  â”‚  æ¬¡å›è«‹æ±‚æ—¥: 2026å¹´2æœˆ10æ—¥                           â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                 â”‚
â”‚  ãŠæ”¯æ‰•ã„æ–¹æ³•                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  ğŸ’³ **** **** **** 4242  VISA                       â”‚       â”‚
â”‚  â”‚  æœ‰åŠ¹æœŸé™: 12/2028                                   â”‚       â”‚
â”‚  â”‚  [Stripeã§ç®¡ç†]  â† Customer Portalã¸é·ç§»             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                 â”‚
â”‚  ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®è§£ç´„                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  è§£ç´„ã™ã‚‹ã¨2026å¹´2æœˆ10æ—¥ã¾ã§ãƒ—ãƒ©ãƒ³ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ â”‚       â”‚
â”‚  â”‚  ãã®å¾Œã¯ç„¡æ–™ãƒ—ãƒ©ãƒ³ã«ç§»è¡Œã—ã¾ã™ã€‚                     â”‚       â”‚
â”‚  â”‚  [è§£ç´„æ‰‹ç¶šãã¸]                                      â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 æ—¢å­˜ç”»é¢ã®ä¿®æ­£

| ç”»é¢ | ä¿®æ­£å†…å®¹ |
|------|----------|
| ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ | ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³è¡¨ç¤ºã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰èª˜å°ãƒãƒŠãƒ¼ |
| æ¨¡è©¦é¸æŠç”»é¢ | ãƒ—ãƒ©ãƒ³åˆ¶é™è¡¨ç¤ºã€ãƒ­ãƒƒã‚¯è¡¨ç¤ºã€ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰å°ç·š |
| åˆ†æç”»é¢ | Proé™å®šã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ­ãƒƒã‚¯è¡¨ç¤º |
| å¾©ç¿’ç”»é¢ | ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ä¸Šé™è¡¨ç¤ºã€åˆ¶é™åˆ°é”æ™‚ã®èª˜å° |
| AIç”Ÿæˆç”»é¢ | æœˆé–“åˆ©ç”¨å›æ•°è¡¨ç¤ºã€åˆ¶é™åˆ°é”æ™‚ã®èª˜å° |
| ã‚µã‚¤ãƒ‰ãƒãƒ¼ | è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ã®ãƒªãƒ³ã‚¯è¿½åŠ  |

---

## 7. APIè¨­è¨ˆ

### 7.1 Server Actions

#### 7.1.1 ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³é–¢é€£ï¼ˆsrc/actions/subscription.tsï¼‰

```typescript
"use server"

// ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—
export async function getSubscription(): Promise<Subscription | null>

// ãƒ—ãƒ©ãƒ³æƒ…å ±å–å¾—ï¼ˆåˆ¶é™å«ã‚€ï¼‰
export async function getPlanLimits(): Promise<PlanLimits>

// Stripe Checkout Sessionä½œæˆ
export async function createCheckoutSession(): Promise<{ url: string } | { error: string }>

// Stripe Customer Portal Sessionä½œæˆ
export async function createPortalSession(): Promise<{ url: string } | { error: string }>

// ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³è§£ç´„ï¼ˆæœŸé–“çµ‚äº†æ™‚ï¼‰
export async function cancelSubscription(): Promise<{ success: boolean; error?: string }>

// è§£ç´„ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆè§£ç´„äºˆå®šã‚’å–ã‚Šæ¶ˆã—ï¼‰
export async function reactivateSubscription(): Promise<{ success: boolean; error?: string }>
```

#### 7.1.2 åˆ©ç”¨åˆ¶é™é–¢é€£ï¼ˆsrc/actions/usage.tsï¼‰

```typescript
"use server"

// ä»Šæ—¥ã®åˆ©ç”¨çŠ¶æ³å–å¾—
export async function getTodayUsage(): Promise<UsageLimits>

// åˆ©ç”¨å›æ•°ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
export async function incrementUsage(
  usageType: 'reading' | 'grammar' | 'vocabulary' | 'ai_passage' | 'ai_grammar' | 'ai_vocabulary'
): Promise<{ allowed: boolean; remaining: number }>

// æ©Ÿèƒ½åˆ©ç”¨å¯å¦ãƒã‚§ãƒƒã‚¯
export async function canUseFeature(
  feature: 'mock_exam_mini' | 'mock_exam_full' | 'detailed_analytics' | 'review_schedule' | 'ai_generation'
): Promise<{ allowed: boolean; reason?: string }>

// æœˆé–“AIåˆ©ç”¨çŠ¶æ³å–å¾—
export async function getMonthlyAIUsage(): Promise<{
  passage: { used: number; limit: number }
  grammar: { used: number; limit: number }
  vocabulary: { used: number; limit: number }
}>
```

#### 7.1.3 è«‹æ±‚é–¢é€£ï¼ˆsrc/actions/billing.tsï¼‰

```typescript
"use server"

// è«‹æ±‚å±¥æ­´å–å¾—
export async function getInvoices(limit?: number): Promise<Invoice[]>

// é ˜åæ›¸URLå–å¾—
export async function getInvoiceUrl(invoiceId: string): Promise<{ url: string } | { error: string }>
```

### 7.2 Webhook Endpointï¼ˆsrc/app/api/webhooks/stripe/route.tsï¼‰

```typescript
import { NextRequest, NextResponse } from "next/server"
import Stripe from "stripe"
import { createServiceClient } from "@/lib/supabase/server"

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!)

export async function POST(request: NextRequest) {
  const body = await request.text()
  const signature = request.headers.get("stripe-signature")!

  let event: Stripe.Event

  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    )
  } catch (err) {
    console.error("Webhook signature verification failed:", err)
    return NextResponse.json(
      { error: "Webhook signature verification failed" },
      { status: 400 }
    )
  }

  const supabase = createServiceClient()

  try {
    switch (event.type) {
      case "checkout.session.completed":
        await handleCheckoutCompleted(supabase, event.data.object)
        break
      case "customer.subscription.created":
        await handleSubscriptionCreated(supabase, event.data.object)
        break
      case "customer.subscription.updated":
        await handleSubscriptionUpdated(supabase, event.data.object)
        break
      case "customer.subscription.deleted":
        await handleSubscriptionDeleted(supabase, event.data.object)
        break
      case "invoice.paid":
        await handleInvoicePaid(supabase, event.data.object)
        break
      case "invoice.payment_failed":
        await handleInvoicePaymentFailed(supabase, event.data.object)
        break
    }
  } catch (err) {
    console.error("Webhook handler error:", err)
    return NextResponse.json(
      { error: "Webhook handler failed" },
      { status: 500 }
    )
  }

  return NextResponse.json({ received: true })
}
```

---

## 8. å‹å®šç¾©ï¼ˆsrc/types/subscription.tsï¼‰

```typescript
// ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—
export type PlanType = 'free' | 'pro'

// ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
export type SubscriptionStatus = 'active' | 'canceled' | 'past_due' | 'incomplete' | 'trialing'

// ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
export interface Subscription {
  id: string
  userId: string
  stripeCustomerId: string | null
  stripeSubscriptionId: string | null
  planType: PlanType
  status: SubscriptionStatus
  currentPeriodStart: string | null
  currentPeriodEnd: string | null
  cancelAtPeriodEnd: boolean
  canceledAt: string | null
  createdAt: string
  updatedAt: string
}

// è«‹æ±‚æ›¸
export interface Invoice {
  id: string
  userId: string
  subscriptionId: string
  stripeInvoiceId: string
  amountPaid: number
  currency: string
  status: string
  invoicePdfUrl: string | null
  hostedInvoiceUrl: string | null
  paidAt: string | null
  createdAt: string
}

// åˆ©ç”¨åˆ¶é™
export interface UsageLimits {
  readingCount: number
  grammarCount: number
  vocabularyCount: number
  aiPassageCount: number
  aiGrammarCount: number
  aiVocabularyCount: number
}

// ãƒ—ãƒ©ãƒ³åˆ¥åˆ¶é™
export interface PlanLimits {
  reading: number | null      // null = unlimited
  grammar: number | null
  vocabulary: number | null
  bookmarks: number | null
  aiPassageMonthly: number | null
  aiGrammarMonthly: number | null
  aiVocabularyMonthly: number | null
  mockExamMini: boolean
  mockExamFull: boolean
  detailedAnalytics: boolean
  reviewSchedule: boolean
}

// ãƒ—ãƒ©ãƒ³åˆ¥åˆ¶é™å®šæ•°
export const PLAN_LIMITS: Record<PlanType, PlanLimits> = {
  free: {
    reading: 5,
    grammar: 10,
    vocabulary: 20,
    bookmarks: 0,
    aiPassageMonthly: 0,
    aiGrammarMonthly: 0,
    aiVocabularyMonthly: 0,
    mockExamMini: false,
    mockExamFull: false,
    detailedAnalytics: false,
    reviewSchedule: false,
  },
  pro: {
    reading: null,  // unlimited
    grammar: null,
    vocabulary: null,
    bookmarks: null,  // unlimited
    aiPassageMonthly: null,  // unlimited
    aiGrammarMonthly: null,
    aiVocabularyMonthly: null,
    mockExamMini: true,
    mockExamFull: true,
    detailedAnalytics: true,
    reviewSchedule: true,
  },
}
```

---

## 9. ç’°å¢ƒå¤‰æ•°

```env
# Stripe API Keys
STRIPE_SECRET_KEY=sk_live_xxx        # æœ¬ç•ªç”¨ï¼ˆã¾ãŸã¯ sk_test_xxx ãƒ†ã‚¹ãƒˆç”¨ï¼‰
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_xxx  # æœ¬ç•ªç”¨ï¼ˆã¾ãŸã¯ pk_test_xxx ãƒ†ã‚¹ãƒˆç”¨ï¼‰

# Stripe Webhook
STRIPE_WEBHOOK_SECRET=whsec_xxx

# Stripe Price IDï¼ˆStripe Dashboardã§ä½œæˆå¾Œã«è¨­å®šï¼‰
STRIPE_PRICE_PRO_MONTHLY=price_xxx
```

---

## 10. Stripe Dashboardè¨­å®š

### 10.1 å•†å“ï¼ˆProductsï¼‰ä½œæˆ

| å•†å“å | ä¾¡æ ¼ | è«‹æ±‚é–“éš” | Price ID |
|--------|------|----------|----------|
| Pro Monthly | Â¥480 | æœˆæ¬¡ | price_xxx |

### 10.2 Customer Portalè¨­å®š

- æœ‰åŠ¹åŒ–
- è§£ç´„è¨±å¯
- è«‹æ±‚å±¥æ­´è¡¨ç¤º
- æ”¯æ‰•ã„æ–¹æ³•æ›´æ–°è¨±å¯

### 10.3 Webhook Endpointsè¨­å®š

- **URL**: `https://yourdomain.com/api/webhooks/stripe`
- **Events**:
  - `checkout.session.completed`
  - `customer.subscription.created`
  - `customer.subscription.updated`
  - `customer.subscription.deleted`
  - `invoice.paid`
  - `invoice.payment_failed`

### 10.4 Checkoutè¨­å®š

- **æˆåŠŸURL**: `https://yourdomain.com/payment/success?session_id={CHECKOUT_SESSION_ID}`
- **ã‚­ãƒ£ãƒ³ã‚»ãƒ«URL**: `https://yourdomain.com/payment/cancel`
- **ãƒ­ã‚±ãƒ¼ãƒ«**: `ja`ï¼ˆæ—¥æœ¬èªï¼‰

---

## 11. å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### Phase 6-A: åŸºç›¤æ§‹ç¯‰
- [ ] Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã€å•†å“ãƒ»ä¾¡æ ¼ä½œæˆ
- [ ] ç’°å¢ƒå¤‰æ•°è¨­å®š
- [ ] `stripe` npmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆï¼ˆ009_add_subscriptions.sqlï¼‰
- [ ] å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆï¼ˆsrc/types/subscription.tsï¼‰
- [ ] Stripeã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šï¼ˆsrc/lib/stripe/client.tsï¼‰

### Phase 6-B: ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
- [ ] Server Actionså®Ÿè£…ï¼ˆsubscription.tsï¼‰
- [ ] Webhook endpointå®Ÿè£…
- [ ] æ–™é‡‘ãƒ—ãƒ©ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆ/pricingï¼‰
- [ ] æ±ºæ¸ˆæˆåŠŸ/ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒšãƒ¼ã‚¸
- [ ] ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ç”»é¢ï¼ˆ/settings/subscriptionï¼‰

### Phase 6-C: åˆ©ç”¨åˆ¶é™æ©Ÿèƒ½
- [ ] Server Actionså®Ÿè£…ï¼ˆusage.tsï¼‰
- [ ] æ—¢å­˜Server Actionsä¿®æ­£
  - reading.ts: æ—¥æ¬¡åˆ¶é™ãƒã‚§ãƒƒã‚¯è¿½åŠ 
  - grammar.ts: æ—¥æ¬¡åˆ¶é™ãƒã‚§ãƒƒã‚¯è¿½åŠ 
  - vocabulary.ts: æ—¥æ¬¡åˆ¶é™ãƒã‚§ãƒƒã‚¯è¿½åŠ 
  - mock-exam.ts: ãƒ—ãƒ©ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯è¿½åŠ 
  - analytics.ts: ãƒ—ãƒ©ãƒ³åˆ¶é™ãƒã‚§ãƒƒã‚¯è¿½åŠ 
  - review.ts: ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯è¿½åŠ 
  - ai/generate-*.ts: æœˆæ¬¡åˆ¶é™ãƒã‚§ãƒƒã‚¯è¿½åŠ 
- [ ] æ—¢å­˜ç”»é¢ã¸ã®åˆ¶é™è¡¨ç¤ºãƒ»ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰èª˜å°UIè¿½åŠ 

### Phase 6-D: è«‹æ±‚ãƒ»ç®¡ç†æ©Ÿèƒ½
- [ ] Server Actionså®Ÿè£…ï¼ˆbilling.tsï¼‰
- [ ] è«‹æ±‚å±¥æ­´ç”»é¢ï¼ˆ/settings/billingï¼‰
- [ ] Customer Portalé€£æº
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ã®ãƒ—ãƒ©ãƒ³è¡¨ç¤ºè¿½åŠ 
- [ ] è¨­å®šç”»é¢ä½œæˆï¼ˆ/settingsï¼‰

### Phase 6-E: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ ] Stripeãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ã®å‹•ä½œç¢ºèª
- [ ] Webhookå‹•ä½œãƒ†ã‚¹ãƒˆï¼ˆStripe CLIä½¿ç”¨ï¼‰
- [ ] å„ãƒ—ãƒ©ãƒ³ã§ã®æ©Ÿèƒ½åˆ¶é™ãƒ†ã‚¹ãƒˆ
- [ ] E2Eãƒ†ã‚¹ãƒˆä½œæˆï¼ˆæ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã¯æ‰‹å‹•ãƒ†ã‚¹ãƒˆï¼‰
- [ ] CLAUDE.mdæ›´æ–°
- [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™

---

## 12. ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆè¿½åŠ åˆ†ï¼‰

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (main)/
â”‚   â”‚   â”œâ”€â”€ pricing/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx           # æ–™é‡‘ãƒ—ãƒ©ãƒ³ãƒšãƒ¼ã‚¸
â”‚   â”‚   â”œâ”€â”€ settings/
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx           # è¨­å®šãƒˆãƒƒãƒ—
â”‚   â”‚   â”‚   â”œâ”€â”€ subscription/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx       # ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ billing/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx       # è«‹æ±‚å±¥æ­´
â”‚   â”‚   â””â”€â”€ payment/
â”‚   â”‚       â”œâ”€â”€ success/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx       # æ±ºæ¸ˆæˆåŠŸ
â”‚   â”‚       â””â”€â”€ cancel/
â”‚   â”‚           â””â”€â”€ page.tsx       # æ±ºæ¸ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ webhooks/
â”‚           â””â”€â”€ stripe/
â”‚               â””â”€â”€ route.ts       # Webhook endpoint
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ subscription/
â”‚   â”‚   â”œâ”€â”€ PricingCard.tsx        # ãƒ—ãƒ©ãƒ³ã‚«ãƒ¼ãƒ‰
â”‚   â”‚   â”œâ”€â”€ PlanComparison.tsx     # ãƒ—ãƒ©ãƒ³æ¯”è¼ƒè¡¨
â”‚   â”‚   â”œâ”€â”€ CurrentPlanBadge.tsx   # ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ãƒãƒƒã‚¸
â”‚   â”‚   â”œâ”€â”€ UpgradeBanner.tsx      # ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰èª˜å°ãƒãƒŠãƒ¼
â”‚   â”‚   â””â”€â”€ UsageMeter.tsx         # åˆ©ç”¨çŠ¶æ³ãƒ¡ãƒ¼ã‚¿ãƒ¼
â”‚   â”œâ”€â”€ billing/
â”‚   â”‚   â”œâ”€â”€ InvoiceList.tsx        # è«‹æ±‚å±¥æ­´ãƒªã‚¹ãƒˆ
â”‚   â”‚   â””â”€â”€ PaymentMethodCard.tsx  # æ”¯æ‰•ã„æ–¹æ³•è¡¨ç¤º
â”‚   â””â”€â”€ settings/
â”‚       â””â”€â”€ SettingsSidebar.tsx    # è¨­å®šã‚µã‚¤ãƒ‰ãƒãƒ¼
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ stripe/
â”‚       â”œâ”€â”€ client.ts              # Stripeã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚       â”œâ”€â”€ prices.ts              # Price ID ãƒãƒƒãƒ”ãƒ³ã‚°
â”‚       â””â”€â”€ webhooks.ts            # Webhook ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”œâ”€â”€ actions/
â”‚   â”œâ”€â”€ subscription.ts            # ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æ“ä½œ
â”‚   â”œâ”€â”€ usage.ts                   # åˆ©ç”¨åˆ¶é™ç®¡ç†
â”‚   â””â”€â”€ billing.ts                 # è«‹æ±‚é–¢é€£
â”œâ”€â”€ types/
â”‚   â””â”€â”€ subscription.ts            # å‹å®šç¾©
â””â”€â”€ supabase/
    â””â”€â”€ migrations/
        â””â”€â”€ 009_add_subscriptions.sql  # DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```

---

## 13. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

| è¦ä»¶ | è©³ç´° |
|------|------|
| **Webhookç½²åæ¤œè¨¼** | `stripe.webhooks.constructEvent()` ã«ã‚ˆã‚‹ç½²åæ¤œè¨¼å¿…é ˆ |
| **PCI DSSæº–æ‹ ** | Stripe Checkoutä½¿ç”¨ã«ã‚ˆã‚ŠPCI DSSã‚¹ã‚³ãƒ¼ãƒ—å¤– |
| **APIã‚­ãƒ¼ç®¡ç†** | Secret Keyã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®ã¿ã€ç’°å¢ƒå¤‰æ•°ã§ç®¡ç† |
| **HTTPSå¿…é ˆ** | å…¨æ±ºæ¸ˆé–¢é€£é€šä¿¡ã¯HTTPSã®ã¿ |
| **RLSé©ç”¨** | subscriptions, invoicesç­‰å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«RLSæœ‰åŠ¹åŒ– |
| **Service Role Key** | Webhookå‡¦ç†ã§ã®ã¿ä½¿ç”¨ã€userIdã‚’æ˜ç¤ºçš„ã«æŒ‡å®š |

---

## 14. éæ©Ÿèƒ½è¦ä»¶

### 14.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

| è¦ä»¶ | ç›®æ¨™å€¤ |
|------|--------|
| ãƒ—ãƒ©ãƒ³ç¢ºèªãƒ¬ã‚¹ãƒãƒ³ã‚¹ | < 100msï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ï¼‰ |
| Webhookå‡¦ç† | < 5ç§’ |
| Checkouté·ç§» | < 3ç§’ |

### 14.2 å¯ç”¨æ€§

| è¦ä»¶ | è©³ç´° |
|------|------|
| Stripeéšœå®³å¯¾å¿œ | Webhookãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ï¼ˆStripeå´ãŒè‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼‰ |
| ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | ãƒ—ãƒ©ãƒ³æƒ…å ±ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ãƒ‡ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | Stripeéšœå®³æ™‚ã‚‚æ—¢å­˜æ©Ÿèƒ½ã¯åˆ©ç”¨å¯èƒ½ |

---

## 15. æ³¨æ„äº‹é …ãƒ»æ³•çš„è¦ä»¶

### 15.1 ç‰¹å®šå•†å–å¼•æ³•å¯¾å¿œ
- ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜ãƒšãƒ¼ã‚¸ã®ä½œæˆå¿…é ˆ
- è²©å£²è€…æƒ…å ±ã€è¿”é‡‘ãƒãƒªã‚·ãƒ¼ç­‰ã®æ˜è¨˜

### 15.2 åˆ©ç”¨è¦ç´„ãƒ»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼
- æœ‰æ–™ã‚µãƒ¼ãƒ“ã‚¹æä¾›ã«ä¼´ã†åˆ©ç”¨è¦ç´„ã®æ›´æ–°
- æ±ºæ¸ˆæƒ…å ±ã®å–ã‚Šæ‰±ã„ã«é–¢ã™ã‚‹ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼æ›´æ–°

### 15.3 ç¨é‡‘å¯¾å¿œ
- æ—¥æœ¬å›½å†…å‘ã‘ã‚µãƒ¼ãƒ“ã‚¹ã®ãŸã‚æ¶ˆè²»ç¨è¾¼ã¿ä¾¡æ ¼è¡¨ç¤º
- Stripe Taxä½¿ç”¨ã¯å°†æ¥æ¤œè¨ï¼ˆç¾çŠ¶ã¯ç¨è¾¼ä¾¡æ ¼ã§è¨­å®šï¼‰

### 15.4 æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ
- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªå‹•çš„ã«Freeãƒ—ãƒ©ãƒ³ã¨ã—ã¦èªè­˜
- subscriptionsãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯Freeæ‰±ã„

---

## 16. å‚è€ƒãƒªãƒ³ã‚¯

- [Stripe Documentation](https://stripe.com/docs)
- [Stripe Checkout](https://stripe.com/docs/payments/checkout)
- [Stripe Billing](https://stripe.com/docs/billing)
- [Stripe Customer Portal](https://stripe.com/docs/customer-management/portal-configuration)
- [Stripe Webhooks](https://stripe.com/docs/webhooks)
- [Next.js + Stripe](https://github.com/vercel/nextjs-subscription-payments)
